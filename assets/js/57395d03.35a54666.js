"use strict";(self.webpackChunkcluster_docs=self.webpackChunkcluster_docs||[]).push([[609],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>m});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},s=Object.keys(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var i=a.createContext({}),u=function(e){var t=a.useContext(i),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},c=function(e){var t=u(e.components);return a.createElement(i.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,s=e.originalType,i=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),d=u(n),m=r,g=d["".concat(i,".").concat(m)]||d[m]||p[m]||s;return n?a.createElement(g,l(l({ref:t},c),{},{components:n})):a.createElement(g,l({ref:t},c))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var s=n.length,l=new Array(s);l[0]=d;var o={};for(var i in t)hasOwnProperty.call(t,i)&&(o[i]=t[i]);o.originalType=e,o.mdxType="string"==typeof e?e:r,l[1]=o;for(var u=2;u<s;u++)l[u]=n[u];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},5162:(e,t,n)=>{n.d(t,{Z:()=>l});var a=n(7294),r=n(6010);const s="tabItem_Ymn6";function l(e){let{children:t,hidden:n,className:l}=e;return a.createElement("div",{role:"tabpanel",className:(0,r.Z)(s,l),hidden:n},t)}},5488:(e,t,n)=>{n.d(t,{Z:()=>m});var a=n(7462),r=n(7294),s=n(6010),l=n(2389),o=n(7392),i=n(7094),u=n(2466);const c="tabList__CuJ",p="tabItem_LNqP";function d(e){var t;const{lazy:n,block:l,defaultValue:d,values:m,groupId:g,className:b}=e,h=r.Children.map(e.children,(e=>{if((0,r.isValidElement)(e)&&"value"in e.props)return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})),k=m??h.map((e=>{let{props:{value:t,label:n,attributes:a}}=e;return{value:t,label:n,attributes:a}})),f=(0,o.l)(k,((e,t)=>e.value===t.value));if(f.length>0)throw new Error(`Docusaurus error: Duplicate values "${f.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`);const v=null===d?d:d??(null==(t=h.find((e=>e.props.default)))?void 0:t.props.value)??h[0].props.value;if(null!==v&&!k.some((e=>e.value===v)))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${v}" but none of its children has the corresponding value. Available values are: ${k.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);const{tabGroupChoices:y,setTabGroupChoices:w}=(0,i.U)(),[N,x]=(0,r.useState)(v),E=[],{blockElementScrollPositionUntilNextRender:O}=(0,u.o5)();if(null!=g){const e=y[g];null!=e&&e!==N&&k.some((t=>t.value===e))&&x(e)}const T=e=>{const t=e.currentTarget,n=E.indexOf(t),a=k[n].value;a!==N&&(O(t),x(a),null!=g&&w(g,String(a)))},C=e=>{var t;let n=null;switch(e.key){case"Enter":T(e);break;case"ArrowRight":{const t=E.indexOf(e.currentTarget)+1;n=E[t]??E[0];break}case"ArrowLeft":{const t=E.indexOf(e.currentTarget)-1;n=E[t]??E[E.length-1];break}}null==(t=n)||t.focus()};return r.createElement("div",{className:(0,s.Z)("tabs-container",c)},r.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,s.Z)("tabs",{"tabs--block":l},b)},k.map((e=>{let{value:t,label:n,attributes:l}=e;return r.createElement("li",(0,a.Z)({role:"tab",tabIndex:N===t?0:-1,"aria-selected":N===t,key:t,ref:e=>E.push(e),onKeyDown:C,onClick:T},l,{className:(0,s.Z)("tabs__item",p,null==l?void 0:l.className,{"tabs__item--active":N===t})}),n??t)}))),n?(0,r.cloneElement)(h.filter((e=>e.props.value===N))[0],{className:"margin-top--md"}):r.createElement("div",{className:"margin-top--md"},h.map(((e,t)=>(0,r.cloneElement)(e,{key:t,hidden:e.props.value!==N})))))}function m(e){const t=(0,l.Z)();return r.createElement(d,(0,a.Z)({key:String(t)},e))}},9704:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>m,frontMatter:()=>o,metadata:()=>u,toc:()=>p});var a=n(7462),r=(n(7294),n(3905)),s=n(5488),l=n(5162);const o={id:"managed-cluster-setup",title:"Managed cluster setup",sidebar_label:"Managed cluster setup",sidebar_position:1,tags:["managed","Initial setup","setup"]},i="Managed Cluster setup",u={unversionedId:"managed-cluster/managed-cluster-setup",id:"managed-cluster/managed-cluster-setup",title:"Managed cluster setup",description:"The managed cluster setup offers a step-by-step setup for a new kubernetes cluster.",source:"@site/docs/managed-cluster/managed-setup.mdx",sourceDirName:"managed-cluster",slug:"/managed-cluster/managed-cluster-setup",permalink:"/cluster-docs/docs/managed-cluster/managed-cluster-setup",draft:!1,editUrl:"https://github.com/nimbit-software/cluster-docs/blob/master/docs/managed-cluster/managed-setup.mdx",tags:[{label:"managed",permalink:"/cluster-docs/docs/tags/managed"},{label:"Initial setup",permalink:"/cluster-docs/docs/tags/initial-setup"},{label:"setup",permalink:"/cluster-docs/docs/tags/setup"}],version:"current",sidebarPosition:1,frontMatter:{id:"managed-cluster-setup",title:"Managed cluster setup",sidebar_label:"Managed cluster setup",sidebar_position:1,tags:["managed","Initial setup","setup"]},sidebar:"clusterDocs",previous:{title:"Managed Cluster",permalink:"/cluster-docs/docs/category/managed-cluster"},next:{title:"Unmanaged cluster setup",permalink:"/cluster-docs/docs/managed-cluster/unmanaged-cluster-setup"}},c={},p=[{value:"Nginx",id:"nginx",level:2},{value:"Load Balancer",id:"load-balancer",level:2},{value:"Cert Manager",id:"cert-manager",level:2}],d={toc:p};function m(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"managed-cluster-setup"},"Managed Cluster setup"),(0,r.kt)("p",null,"The managed cluster setup offers a step-by-step setup for a new kubernetes cluster. "),(0,r.kt)("p",null,"Ideally the clusters should be managed by ",(0,r.kt)("strong",{parentName:"p"},"argocd")," but there is still some initial setup to be done to allow the cluster to communicate with the outside world. "),(0,r.kt)("p",null,"We assume that you already have the cluster of you choice set up. To make sure you are using a fresh cluster run: "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"kubeclt get namespaces\n")),(0,r.kt)("p",null,"The output should look like this "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-buttonless"},"$ kubectl get namespaces\nNAME              STATUS   AGE\ndefault           Active   138d\nkube-node-lease   Active   40m\nkube-public       Active   138d\nkube-system       Active   138d\n")),(0,r.kt)("p",null,"So now we have a clean cluster its time to get started."),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"nginx"},"Nginx"),(0,r.kt)("p",null,"Most clusters want to allow users to access at least certain parts of it from outside the cluster. While we can expose specific node ports outside the cluster, a load balancer makes the most sense and allows us to have more control over our routes in a central place. "),(0,r.kt)("p",null,"Load balancers expose the cluster to the outside world in a safe and manageable way while proving a lot of additional features"),(0,r.kt)("p",null,"While there are a few different load balancers out there we will be using the ",(0,r.kt)("a",{parentName:"p",href:"https://kubernetes.github.io/ingress-nginx/deploy/"},"NGINX")," load balancer. "),(0,r.kt)("p",null,"We will be using helm to install nginx as it is the easiest way to get it up and running."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},'# WE WILL USE THE NAMESPACE ingress-nginx WHICH IS CREATED FOR US \n\nhelm upgrade --install ingress-nginx ingress-nginx \\\n  --repo https://kubernetes.github.io/ingress-nginx \\\n  --namespace ingress-nginx --create-namespace\n  --set controller.service.annotations."service\\.beta\\.kubernetes\\.io/azure-load-balancer-health-probe-request-path"=/healthz\n')),(0,r.kt)("p",null,"A few pods should start in the ingress-nginx namespace:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"kubectl get pods --namespace=ingress-nginx\n")),(0,r.kt)("p",null,"After a while, they should all be running. The following command will wait for the ingress controller pod to be up, running, and ready:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"kubectl wait --namespace ingress-nginx \\\n  --for=condition=ready pod \\\n  --selector=app.kubernetes.io/component=controller \\\n  --timeout=120s\n")),(0,r.kt)("admonition",{type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"  Some kubernetes environments require additional configuration before setting up the load balancer ")),(0,r.kt)(s.Z,{mdxType:"Tabs"},(0,r.kt)(l.Z,{value:"Azure",label:"Azure",default:!0,mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.4.0/deploy/static/provider/cloud/deploy.yaml\n")))),(0,r.kt)("h2",{id:"load-balancer"},"Load Balancer"),(0,r.kt)("p",null,"Having created the nginx ingress we can now create our generic load balancer."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"kubectl apply -f - <<EOF\nkind: Service\napiVersion: v1\nmetadata:\n  name: ingress-nginx-controller\n  namespace: ingress-nginx\n  labels:\n    app.kubernetes.io/name: ingress-nginx\n    app.kubernetes.io/part-of: ingress-nginx\nspec:\n  type: LoadBalancer\n  selector:\n    app.kubernetes.io/name: ingress-nginx\n    app.kubernetes.io/part-of: ingress-nginx\n  ports:\n    - name: http\n      port: 80\n      targetPort: http\n    - name: https\n      port: 443\n      targetPort: https      \nEOF\n\n")),(0,r.kt)("p",null,"You load balancer should be set up now with all the bells and whistles "),(0,r.kt)("h2",{id:"cert-manager"},"Cert Manager"),(0,r.kt)("p",null,"The cert manager is responsible for creating certificates for you apps and making sure that they are kept up to date. "),(0,r.kt)("p",null,"We will be using lets encrypt for as our certification authority.\nWe will also be using helm to deploy our cert-manager"),(0,r.kt)("p",null,"Add helm repo and update repo"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh",metastring:'title="Add repo and update repo"',title:'"Add',repo:!0,and:!0,update:!0,'repo"':!0},"helm repo add jetstack https://charts.jetstack.io\nhelm repo update\n")),(0,r.kt)("p",null,"Now we need to apply the custom resource definition (CRD)"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.10.0/cert-manager.crds.yaml\n")),(0,r.kt)("admonition",{type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"If cert-manager already exists you can remove it using "),(0,r.kt)("pre",{parentName:"admonition"},(0,r.kt)("code",{parentName:"pre"},"helm uninstall cert-manager --namespace cert-manager\n"))),(0,r.kt)("p",null,"Now let install cert manager"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"helm install cert-manager jetstack/cert-manager --namespace cert-manager --version v1.10.0  --create-namespace --set installCRDs=true\n\n")),(0,r.kt)("p",null,"After setting up the cert manager we need to set up a cluster issuer.\nThe cluster issuer is responsible for creating certificates in all namespaces"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh",metastring:'title="Cluster issuer"',title:'"Cluster','issuer"':!0},"kubectl apply -f - <<EOF\napiVersion: cert-manager.io/v1\nkind: ClusterIssuer\nmetadata:\n  name: le-clusterissuer\n  namespace: cert-manager\nspec:\n  acme:\n    server: https://acme-v02.api.letsencrypt.org/directory\n    email: iot@nimbit.de\n    privateKeySecretRef:\n      name: le-clusterissuer\n    solvers:\n    - http01:\n        ingress:\n          class:  nginx\nEOF\n\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"kubectl apply -f - <<EOF\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: udp-services\n  namespace: ingress-nginx\nEOF\n\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"kubectl apply -f - <<EOF\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: tcp-services\n  namespace: ingress-nginx\nEOF\n\n")))}m.isMDXComponent=!0}}]);